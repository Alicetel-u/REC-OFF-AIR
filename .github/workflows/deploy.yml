name: Deploy to GitHub Pages

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  export-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Godot 4.6.1
        run: |
          wget -q https://github.com/godotengine/godot/releases/download/4.6.1-stable/Godot_v4.6.1-stable_linux.x86_64.zip
          unzip -q Godot_v4.6.1-stable_linux.x86_64.zip
          chmod +x Godot_v4.6.1-stable_linux.x86_64
          sudo mv Godot_v4.6.1-stable_linux.x86_64 /usr/local/bin/godot

      - name: Install Web export templates
        run: |
          mkdir -p ~/.local/share/godot/export_templates/4.6.1.stable
          wget -q https://github.com/godotengine/godot/releases/download/4.6.1-stable/Godot_v4.6.1-stable_export_templates.tpz
          unzip -q Godot_v4.6.1-stable_export_templates.tpz -d /tmp/templates
          mv /tmp/templates/templates/* ~/.local/share/godot/export_templates/4.6.1.stable/

      - name: Write export presets
        run: |
          cat > export_presets.cfg << 'EOF'
          [preset.0]

          name="Web"
          platform="Web"
          runnable=true
          dedicated_server=false
          custom_features=""
          export_filter="all_resources"
          include_filter=""
          exclude_filter=""
          export_path="web/index.html"
          encrypt_pck=false
          encrypt_directory=false

          [preset.0.options]

          custom_template/debug=""
          custom_template/release=""
          variant/extensions_support=false
          vram_texture_compression/for_desktop=true
          vram_texture_compression/for_mobile=false
          html/export_icon=true
          html/custom_html_shell=""
          html/head_include=""
          html/canvas_resize_policy=2
          html/focus_canvas_on_start=true
          html/experimental_virtual_keyboard=false
          progressive_web_app/enabled=false
          EOF

      - name: Install Japanese fonts
        run: |
          sudo apt-get install -y fonts-noto-cjk
          mkdir -p assets/fonts
          find /usr/share/fonts -name "NotoSansCJK-Regular.ttc" | head -1 | xargs -I{} cp {} assets/fonts/NotoSansCJK-Regular.ttc

      - name: Web export
        run: |
          mkdir -p web
          godot --headless --path . --export-release "Web" web/index.html
          touch web/.nojekyll

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./web
          force_orphan: true
